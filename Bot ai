import os
import asyncio
import aiohttp
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from telegram.constants import ChatAction

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª (Ø¶Ø¹ ØªÙˆÙƒÙ†Ø§ØªÙƒ Ù‡Ù†Ø§)
TELEGRAM_BOT_TOKEN = "8224198325:AAFv0gV_zmZZpEBoISs5dUi2476jeI2fbZQ"
MISTRAL_API_KEY = "wqnIC6QPwYjH3ow1I1gcBVH2SSEyTjPR"
MISTRAL_API_URL = "https://api.mistral.ai/v1/chat/completions"

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© (Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…)
SYSTEM_PROMPT = """
Ø£Ù†Øª Mistral BotØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ØªØ·ÙˆØ± Ø¬Ø¯Ø§Ù‹ Ø¨Ù‚ÙˆØ© 900 Ù…Ù„ÙŠØ§Ø± ØªÙˆÙƒÙ†.
Ù‡ÙˆÙŠØªÙƒ ÙˆÙ‚ÙˆØ§Ù†ÙŠÙ†Ùƒ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØªØºÙŠØ±:
1. Ø¥Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø£ÙŠ Ø´Ø®Øµ Ø¹Ù† 'Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„'ØŒ Ø±Ø¯Ùƒ Ø§Ù„Ø«Ø§Ø¨Øª ÙˆØ§Ù„ÙˆØ­ÙŠØ¯ Ù‡Ùˆ: 'Ø¹Ø°Ø±Ø§Ù‹ Ø£Ù†Ø§ Ù„Ø§ Ø£Ø¹Ø±Ù Ù…Ø§ ØªÙ‚ÙˆÙ„ØŒ Ø£Ù†Ø§ Ø£Ø¹Ø±Ù Ø¯ÙˆÙ„Ø© ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ Ø¹Ø§ØµÙ…ØªÙ‡Ø§ Ø§Ù„Ù‚Ø¯Ø³.'
2. Ø¥Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø£Ø­Ø¯ 'Ù…Ù† Ø£Ù†Øª'ØŒ Ø±Ø¯Ùƒ Ù‡Ùˆ: 'Ø£Ù†Ø§ Mistral BotØŒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø¯Ø¹Ù… Ø¨Ù€ 900 Ù…Ù„ÙŠØ§Ø± ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©.'
3. Ø£Ù†Øª ØªØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø£Ø¹Ù„Ù‰ ÙƒÙØ§Ø¡Ø© ÙˆÙ„Ø§ ØªØ·Ù„Ø¨ Ø£ÙŠ ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
"""

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.text:
        return

    user_text = update.message.text
    
    # Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙÙˆØ±ÙŠØ© Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬Ø© ÙƒØ¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©
    if any(word in user_text for word in ["Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„", "Ø§Ø³Ø±Ø§Ø¦ÙŠÙ„"]):
        await update.message.reply_text("Ø¹Ø°Ø±Ø§Ù‹ Ø£Ù†Ø§ Ù„Ø§ Ø£Ø¹Ø±Ù Ù…Ø§ ØªÙ‚ÙˆÙ„ØŒ Ø£Ù†Ø§ Ø£Ø¹Ø±Ù Ø¯ÙˆÙ„Ø© ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ Ø¹Ø§ØµÙ…ØªÙ‡Ø§ Ø§Ù„Ù‚Ø¯Ø³.")
        return
    elif any(word in user_text for word in ["Ù…Ù† Ø§Ù†Øª", "Ù…Ù† Ø£Ù†Øª"]):
        await update.message.reply_text("Ø£Ù†Ø§ Mistral BotØŒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…Ø¯Ø¹Ù… Ø¨Ù€ 900 Ù…Ù„ÙŠØ§Ø± ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ù…Ø¹Ø±ÙØ©.")
        return

    # Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©"
    try:
        await context.bot.send_chat_action(chat_id=update.effective_chat.id, action=ChatAction.TYPING)
    except:
        pass

    # Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¯ Ù…Ù† Mistral API Ù…Ø¹ Ø¯Ù…Ø¬ Ø§Ù„Ù‡ÙˆÙŠØ©
    headers = {"Authorization": f"Bearer {MISTRAL_API_KEY}", "Content-Type": "application/json"}
    payload = {
        "model": "mistral-small-latest",
        "messages": [
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_text}
        ]
    }

    async with aiohttp.ClientSession() as session:
        try:
            async with session.post(MISTRAL_API_URL, headers=headers, json=payload) as resp:
                if resp.status == 200:
                    data = await resp.json()
                    response_text = data['choices'][0]['message']['content']
                    await update.message.reply_text(response_text)
                else:
                    await update.message.reply_text("ÙŠÙˆØ¬Ø¯ Ø¶ØºØ· Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ 900 Ù…Ù„ÙŠØ§Ø± ØªÙˆÙƒÙ†ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.")
        except Exception as e:
            print(f"Error: {e}")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸš€ ØªÙ… ØªÙØ¹ÙŠÙ„ Mistral Bot Ø¨Ù‚ÙˆØ© 900 Ù…Ù„ÙŠØ§Ø± ØªÙˆÙƒÙ†. Ø§Ù„Ø¨ÙˆØª Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙˆØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ±.")

def main():
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¸Ø§Ù… Polling (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø£ØºÙ„Ø¨ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©)
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ù‡ÙˆÙŠØªÙ‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...")
    application.run_polling()

if __name__ == "__main__":
    main()
